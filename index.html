<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoArt AI - GitHub Edition</title>
    <style>
        :root { --primary: #8b5cf6; --dark: #0f172a; --panel: #1e293b; --text: #f8fafc; }
        body { font-family: sans-serif; background: var(--dark); color: var(--text); display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        
        .main-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 1200px; width: 100%; }
        .controls { background: var(--panel); padding: 20px; border-radius: 12px; min-width: 300px; flex: 1; }
        .canvas-area { position: relative; background: #000; border-radius: 12px; overflow: hidden; min-height: 400px; flex: 2; border: 2px dashed #334155; display:flex; align-items:center; justify-content:center;}
        
        canvas { width: 100%; height: 100%; object-fit: contain; }
        
        button, select, input[type="text"] { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: none; }
        button { cursor: pointer; font-weight: bold; background: var(--primary); color: white; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        input[type="text"] { background: #334155; color: white; }
        
        .status { position: absolute; color: white; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; pointer-events: none; display: none; }
    </style>
</head>
<body>

    <h1>GeoArt AI Studio</h1>

    <div class="main-container">
        <div class="controls">
            <h3>1. Configurar IA</h3>
            <input type="text" id="promptInput" placeholder="Ex: Cyberpunk city, neon lights...">
            
            <h3>2. Modo TV (Tempo)</h3>
            <select id="timerSelect">
                <option value="1">1 Minuto</option>
                <option value="2">2 Minutos</option>
                <option value="5">5 Minutos</option>
            </select>
            
            <div style="display:flex; gap:10px;">
                <button id="btnStart" style="background:#10b981;">‚ñ∂ Iniciar TV</button>
                <button id="btnStop" style="background:#ef4444; display:none;">‚èπ Parar</button>
            </div>

            <hr style="border-color: #334155; margin: 20px 0;">

            <h3>3. Estilo</h3>
            <label>Fundo:</label>
            <input type="color" id="bgColor" value="#0f172a" style="width:100%; height:40px;">
            
            <label>Transpar√™ncia Formas:</label>
            <input type="range" id="opacitySlider" min="5" max="100" value="30" style="width:100%;">
            
            <button id="btnDownload" style="margin-top:20px;">üíæ Salvar Arte</button>
        </div>

        <div class="canvas-area">
            <div class="status" id="statusMsg">Carregando...</div>
            <canvas id="artCanvas"></canvas>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const canvas = document.getElementById('artCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const statusMsg = document.getElementById('statusMsg');

        let state = {
            running: false,
            intervalId: null,
            animationId: null,
            width: 0,
            height: 0,
            pixels: null,
            bgColor: '#0f172a',
            opacity: 0.3
        };

        // --- MOTOR DE IMAGEM (CORRIGIDO PARA GITHUB/WEB) ---
        async function carregarImagem(url) {
            if(state.animationId) cancelAnimationFrame(state.animationId);
            
            statusMsg.style.display = 'block';
            statusMsg.innerText = "Baixando imagem da IA...";

            try {
                // Fetch resolve problemas de CORS melhor que Image.src direto
                const response = await fetch(url);
                if (!response.ok) throw new Error("Erro na API");
                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);

                const img = new Image();
                img.crossOrigin = "Anonymous"; // CRUCIAL PARA O CANVAS FUNCIONAR
                
                img.onload = () => {
                    URL.revokeObjectURL(objectUrl);
                    statusMsg.style.display = 'none';
                    iniciarGeoArt(img);
                };
                
                img.onerror = () => { throw new Error("Imagem inv√°lida"); };
                img.src = objectUrl;

            } catch (error) {
                console.error(error);
                statusMsg.innerText = "Erro: " + error.message;
            }
        }

        function iniciarGeoArt(img) {
            // Configurar Canvas
            const scale = Math.min(1, 1200 / img.width);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            state.width = canvas.width;
            state.height = canvas.height;

            // Desenhar imagem para ler pixels
            ctx.drawImage(img, 0, 0, state.width, state.height);
            
            try {
                // Tenta ler os pixels
                state.pixels = ctx.getImageData(0, 0, state.width, state.height).data;
            } catch (e) {
                alert("Erro de Seguran√ßa do Navegador! Use HTTPS ou Localhost.");
                return;
            }

            // Limpa com a cor de fundo escolhida
            ctx.fillStyle = state.bgColor;
            ctx.fillRect(0, 0, state.width, state.height);

            // Inicia Loop
            if (!state.running) state.running = true;
            loopDesenho();
        }

        function loopDesenho() {
            if (!state.running) return;

            // Desenha 50 formas por frame
            for(let i=0; i<50; i++) {
                const x = Math.floor(Math.random() * state.width);
                const y = Math.floor(Math.random() * state.height);
                const index = (y * state.width + x) * 4;

                const r = state.pixels[index];
                const g = state.pixels[index+1];
                const b = state.pixels[index+2];
                const a = state.pixels[index+3];

                if (a < 50) continue; // Pula pixel transparente

                ctx.fillStyle = `rgba(${r},${g},${b},${state.opacity})`;
                
                const size = Math.random() * 40 + 5;
                
                // Desenha C√≠rculo
                ctx.beginPath();
                ctx.arc(x, y, size/2, 0, Math.PI*2);
                ctx.fill();
            }
            state.animationId = requestAnimationFrame(loopDesenho);
        }

        // --- CONTROLES DA TV ---
        function proximaImagem() {
            const prompt = document.getElementById('promptInput').value || "Abstract geometric art, colorful";
            const seed = Math.floor(Math.random() * 999999);
            // URL DA API POLLINATIONS (MODELO FLUX)
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1024&height=768&seed=${seed}&model=flux&nologo=true`;
            
            carregarImagem(url);
        }

        document.getElementById('btnStart').onclick = () => {
            state.running = true;
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnStop').style.display = 'block';
            
            proximaImagem(); // Primeira imagem
            
            const minutos = parseInt(document.getElementById('timerSelect').value);
            state.intervalId = setInterval(proximaImagem, minutos * 60 * 1000);
        };

        document.getElementById('btnStop').onclick = () => {
            state.running = false;
            document.getElementById('btnStart').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';
            clearInterval(state.intervalId);
            cancelAnimationFrame(state.animationId);
        };

        // UI Updates
        document.getElementById('bgColor').addEventListener('input', (e) => {
            state.bgColor = e.target.value;
            ctx.fillStyle = state.bgColor;
            ctx.fillRect(0, 0, state.width, state.height);
        });

        document.getElementById('opacitySlider').addEventListener('input', (e) => {
            state.opacity = e.target.value / 100;
        });

        document.getElementById('btnDownload').onclick = () => {
            const link = document.createElement('a');
            link.download = 'arte-ia.png';
            link.href = canvas.toDataURL();
            link.click();
        };

        // Timer din√¢mico
        document.getElementById('timerSelect').addEventListener('change', (e) => {
            if(state.running) {
                clearInterval(state.intervalId);
                const minutos = parseInt(e.target.value);
                state.intervalId = setInterval(proximaImagem, minutos * 60 * 1000);
            }
        });

    </script>
</body>
</html>
