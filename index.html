<script>
        // CONFIGURAÇÃO
        const canvas = document.getElementById('artCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const config = { width: 1920, height: 1080 };
        
        let isRunning = false;
        let imgData = null; 
        
        function init() {
            canvas.width = config.width;
            canvas.height = config.height;
            processUrl("https://picsum.photos/1920/1080", "Iniciando sistema...");
        }

        function processUrl(url, msg) {
            setLoading(true, msg);
            isRunning = false;

            const img = new Image();
            img.crossOrigin = "Anonymous"; 
            
            // Tratamento de Cache
            if(url.includes('?')) img.src = url + "&t=" + Date.now();
            else img.src = url + "?t=" + Date.now();
            
            img.onload = () => {
                const off = document.createElement('canvas');
                off.width = config.width; off.height = config.height;
                const offCtx = off.getContext('2d');
                
                const r = Math.max(config.width/img.width, config.height/img.height);
                const w = img.width*r, h = img.height*r;
                offCtx.drawImage(img, (config.width-w)/2, (config.height-h)/2, w, h);
                
                try {
                    imgData = offCtx.getImageData(0,0, config.width, config.height).data;
                    startAnimation();
                } catch(e) {
                    console.error(e);
                    setLoading(true, "Erro de Segurança (CORS). Tente outro termo.");
                }
            };
            
            img.onerror = () => {
                setLoading(true, "Falha ao baixar. Tentando aleatório...");
                setTimeout(() => runRandom(), 2000);
            };
        }

        function startAnimation() {
            setLoading(false);
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, config.width, config.height);
            isRunning = true;
            requestAnimationFrame(drawLoop);
        }

        function drawLoop() {
            if(!isRunning || !imgData) return;
            
            const speed = 80; // Aumentei um pouco a velocidade
            const evolution = document.getElementById('chkEvo').checked;

            for(let i=0; i<speed; i++) {
                const x = Math.floor(Math.random() * config.width);
                const y = Math.floor(Math.random() * config.height);
                const idx = (y * config.width + x) * 4;
                
                const r = imgData[idx];
                const g = imgData[idx+1];
                const b = imgData[idx+2];
                
                if(r < 15 && g < 15 && b < 15) continue;

                ctx.fillStyle = `rgb(${r},${g},${b})`;
                ctx.beginPath();
                
                let size = Math.random() * 30 + 4;
                if(evolution) size = Math.random() * 50 + 2;

                if(Math.random() > 0.5) {
                    ctx.arc(x, y, size/2, 0, Math.PI*2);
                    ctx.fill();
                } else {
                    ctx.fillRect(x - size/2, y - size/2, size, size);
                }
            }
            requestAnimationFrame(drawLoop);
        }

        // --- FUNÇÃO CORRIGIDA ---
        function runAI() {
            const txt = document.getElementById('aiInput').value.trim();
            if(!txt) return;
            
            const seed = Math.floor(Math.random() * 999999);
            // Adicionado 'private=true' e encodeURIComponent correto
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(txt)}?width=1280&height=720&model=flux&nologo=true&private=true&seed=${seed}`;
            
            processUrl(url, "IA Criando (Aguarde)...");
        }

        function runSearch() {
            const txt = document.getElementById('searchInput').value;
            if(!txt) return;
            const url = `https://loremflickr.com/1280/720/${encodeURIComponent(txt)}`;
            processUrl(url, "Buscando Imagem...");
        }

        function runRandom() {
            processUrl(`https://picsum.photos/1280/720`, "Sorteando...");
        }

        function openPanel(id) {
            document.querySelectorAll('.input-group').forEach(el => el.style.display = 'none');
            const el = document.getElementById('panel-'+id);
            if(el) el.style.display = 'block';
        }
        
        function setLoading(show, msg) {
            const el = document.getElementById('loader');
            el.style.display = show ? 'flex' : 'none';
            if(msg) document.getElementById('statusText').innerText = msg;
        }

        function downloadArt() {
            const a = document.createElement('a');
            a.download = 'GeoArt-HD.png';
            a.href = canvas.toDataURL('image/png');
            a.click();
        }
        
        function handleEnter(e, func) { if(e.key === 'Enter') func(); }

        init();
    </script>
